{% extends 'web_interface/base.html' %}
{% load static %}
{% block title %}Logs del Sistema{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Registros del Sistema</h3>
      </div>

      <div class="card-body">
        <!-- Filtros -->
        <div class="row mb-3">
          <div class="col-md-3">
            <select id="filter-level" class="form-control form-control-sm">
              <option value="">Todos los niveles</option>
              {% for level, label in levels %}
                <option value="{{ level }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <select id="filter-source" class="form-control form-control-sm">
              <option value="">Todas las fuentes</option>
              {% for source in sources %}
                <option value="{{ source }}">{{ source }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar en mensaje...">
          </div>
          <div class="col-md-3">
            <button id="refresh-btn" class="btn btn-sm btn-primary">Actualizar</button>
            <button id="auto-refresh-toggle" class="btn btn-sm btn-outline-info">Auto: ON</button>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <input type="date" id="from-date" class="form-control form-control-sm">
          </div>
          <div class="col-md-3">
            <input type="date" id="to-date" class="form-control form-control-sm">
          </div>
          <div class="col-md-3">
            <select id="page-size" class="form-control form-control-sm">
              <option value="10">10 por página</option>
              <option value="25" selected>25 por página</option>
              <option value="50">50 por página</option>
              <option value="100">100 por página</option>
            </select>
          </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Nivel</th>
                <th>Mensaje</th>
                <th>Fuente</th>
              </tr>
            </thead>
            <tbody id="logs-body">
              <!-- Llenado por AJAX -->
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <nav aria-label="Paginación" class="mt-3">
          <ul class="pagination pagination-sm justify-content-center" id="pagination">
            <!-- Llenado por AJAX -->
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const logsUrl = '{% url "web_interface:logs" %}';
let autoRefresh = true;
let refreshInterval;

// Función para cargar logs
function loadLogs() {
  const params = new URLSearchParams({
    level: $('#filter-level').val(),
    source: $('#filter-source').val(),
    search: $('#search-input').val(),
    from_date: $('#from-date').val(),
    to_date: $('#to-date').val(),
    page_size: $('#page-size').val(),
    page: $('.page-item.active').data('page') || 1
  });

  $.getJSON(logsUrl + '?' + params, function(data) {
    const tbody = $('#logs-body');
    tbody.empty();

    data.logs.forEach(log => {
      const row = `
        <tr>
          <td>${log.timestamp}</td>
          <td>
            <span class="badge bg-${{
              'INFO': 'info',
              'WARNING': 'warning',
              'ERROR': 'danger',
              'CRITICAL': 'dark'
            }[log.level]}">${log.level}</span>
          </td>
          <td>${log.message.substring(0, 100)}${log.message.length > 100 ? '...' : ''}</td>
          <td><span class="badge bg-secondary">${log.source}</span></td>
        </tr>`;
      tbody.append(row);
    });

    // Paginación
    const pagination = $('#pagination');
    pagination.empty();

    if (data.pagination.has_previous) {
      pagination.append(`<li class="page-item"><a class="page-link" href="#" data-page="${data.pagination.current_page - 1}">&laquo;</a></li>`);
    }

    for (let i = 1; i <= data.pagination.num_pages; i++) {
      const active = i === data.pagination.current_page ? 'active' : '';
      pagination.append(`<li class="page-item ${active}" data-page="${i}"><a class="page-link" href="#">${i}</a></li>`);
    }

    if (data.pagination.has_next) {
      pagination.append(`<li class="page-item"><a class="page-link" href="#" data-page="${data.pagination.current_page + 1}">&raquo;</a></li>`);
    }
  });
}

// Eventos
$(document).ready(function() {
  loadLogs(); // Cargar al inicio

  // Refrescar
  $('#refresh-btn').click(loadLogs);

  // Auto-refresh
  $('#auto-refresh-toggle').click(function() {
    autoRefresh = !autoRefresh;
    $(this).text('Auto: ' + (autoRefresh ? 'ON' : 'OFF'));
    if (autoRefresh) {
      refreshInterval = setInterval(loadLogs, 30000); // Cada 30 segundos
    } else {
      clearInterval(refreshInterval);
    }
  });

  // Iniciar auto-refresh
  refreshInterval = setInterval(loadLogs, 30000);

  // Filtros y paginación
  $('#filter-level, #filter-source, #search-input, #from-date, #to-date, #page-size').change(loadLogs);
  $(document).on('click', '.page-link', function(e) {
    e.preventDefault();
    $('.page-item').removeClass('active');
    $(this).parent().addClass('active');
    loadLogs();
  });
});
</script>
{% endblock %}