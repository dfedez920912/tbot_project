{% extends 'web_interface/base.html' %}
{% load static %}
{% block name%}<title>TBot Project | Telegram</title>{%endblock%}
{% block title %}Configuración de Telegram{% endblock %}

{% block content %}
<div class="row">
    <!-- Formulario: API de Telegram -->
    <div class="col-md-6">
      <div class="card card-primary">
        <div class="card-header">
          <h3 class="card-title">API de Telegram</h3>
        </div>
        <form id="api-form">
          {% csrf_token %}
          <div class="card-body">
            <div class="form-group">
              <label for="TELEGRAM_BOT_TOKEN">Token del Bot</label>
              <input type="text" class="form-control" id="TELEGRAM_BOT_TOKEN" name="TELEGRAM_BOT_TOKEN" value="{{ telegram_token }}">
            </div>
            <div class="d-flex justify-content-end mt-3">
              <button type="button" id="test-token-btn" class="btn btn-info mr-2">Verificar Token</button>
              <button type="button" id="save-api-btn" class="btn btn-primary">Guardar API</button>
            </div>
               <!-- Cargando -->
              <div id="loading-api" class="text-center" style="display: none; margin-top: 10px;">
                <div class="spinner-border text-primary" role="status">
                  <span class="sr-only">Verificando...</span>
                </div>
                <p class="mt-2">Verificando token...</p>
              </div>
          
          </div>
        </form>
      </div>
    </div>

    <!-- Formulario: Mensajes del Bot -->
    <div class="col-md-6">
      <div class="card card-success">
        <div class="card-header">
          <h3 class="card-title">Mensajes del Bot</h3>
        </div>
        <form id="messages-form">
          <div class="card-body" style="max-height: 60vh; overflow-y: auto;">
            {% for section in processed_messages %}
            <!-- Título de sección -->
            <div class="form-group">
              <label style="font-weight: bold; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 5px; margin-top: 15px;">
                {{ section.title }}
              </label>
            </div>
            <!-- Campos de la sección -->
            {% for field in section.fields %}
            <div class="form-group">
              <label for="message_{{ field.key }}">{{ field.label }}</label>
              <textarea class="form-control" id="message_{{ field.key }}" name="message_{{ field.key }}" rows="2">{{ field.value }}</textarea>
            </div>
            {% endfor %}
            {% endfor %}
          </div>
          <div class="mt-3" style="border-top: 1px solid var(--border); padding-top: 10px; background: var(--bg-secondary);">
            <button type="button" id="preview-btn" class="btn btn-secondary">Vista Previa</button>
            <button type="button" id="save-messages-btn" class="btn btn-primary float-right" disabled>Guardar Mensajes</button>
          </div>
        </form>
      </div>
    </div>
</div>

<!-- Modal de Vista previa -->
<div class="modal fade" id="preview-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content"">
      <div class="modal-header">
        <h5 class="modal-title">Vista Previa en Telegram</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="preview-content">
        <!-- Mensajes se mostrarán aquí -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="confirm-save-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Guardado</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>¿Desea guardar los cambios?</p>
        <ul id="changes-list"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirm-save-btn">Guardar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    let currentFormAction = null;
</script>
{% endblock %}

{% block custom_scripts %}
<script src="{% static 'web_interface/js/config_telegram.js' %}"></script>
{% endblock %}